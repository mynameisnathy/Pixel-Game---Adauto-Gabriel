<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fase 2 - Montanhas</title>
  <link rel="icon" href="/icon.png" type="image/png">
</head>
<body>
    
    <audio id="autoplay" src="/alonelytree.mp3.mpeg" loop preload="auto"></audio>

    <div class="game-board">
        <button class="start-button" onclick="window.location.href='fases.html'">Voltar</button>
        <img src="adauto.png" class="mario">
        <img src="m.o.2.webp" class="pipe">
        <img src="/casa2.png" class="finish" style="display:none">
        <div class="game-over">
            <button class="restart">Tente de novo</button>
        </div>
        <div id="loadingOverlay" class="loading-overlay" style="display:none">
            <div class="loading-box">
                <p id="loadingText">Carregando <br> proxima fase...</p>
                <div class="progress"><div id="loadingBar" class="bar"></div></div>
            </div>
        </div>
    </div>

    <style>

        @font-face {
            font-family: 'minecraft';
            src: url(minecraft/Minecraft.ttf) format('truetype');
        }

        *{
    margin: 0;
    padding: 0;
    box-sizing: 0;
    font-family: 'Minecraft';
    background-position: center;
}

    body {
        height: 50%;
        width: 99.2%;
        background-image: url('montanhas.jpg');
        background-size: 75% 100%;
        background-position: top;
        background-attachment: fixed;
        overflow: hidden;
    }

     .loading-overlay{
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
    }
    .loading-box{
        background: #b3deb6;
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        min-width: 240px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

       .progress{
        width: 100%;
        height: 10px;
        background: #b3deb6;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
    }
    .progress .bar{
        width: 0%;
        height: 100%;
        background: #24b34a;
        transition: width 0.08s linear;
    }

    .start-button {
      margin-top: 20px;
      margin-left: 20px;
      padding: 10px 25px;
      font-size: 20px;
      background-color: #a6ffde;
      font-family: 'Minecraft';
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 3px 3px #58c492;
    }

    .start-button:hover {
      background-color: #176e5a;
      box-shadow: 3px 3px #094f38;
      color: white;
    } 


.game-board{
    width: 100%;
    height: 450px;
    margin: 0 auto;
    margin-right: initial;
    position: relative;
    overflow: hidden;

}

.pipe{
    position: absolute;
    bottom: 0;
    width: 50px;
    animation: pipe-animations 2.5s infinite linear;
}

.mario{
    width: 75px;
    position: absolute;
    bottom: 0px;
    left: 0px;
}

.finish{
    position: absolute;
    bottom: 0px;
    width: 300px;
    right: -200px;
    display: none; 
}

.jump{
    animation: mario-animation 660ms ease-out;
}


.game-over{
    visibility: hidden;
    display: flex;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    justify-content: center;
    align-items: center;
    background-color: rgba(41, 115, 80, 0.578);
}

.restart{
    height: 60px;
    background-color: rgba(0, 116, 62, 0.644);
    width: 180px;
    border-radius: 10px;
    border: none;
    font-size: 20px;
    font-family: 'minecraft';
    color: rgba(215, 255, 242, 0.922);
    cursor: pointer;
}

@keyframes pipe-animations {
    from{
        right: -80px;
    }

    to{
        right: 100%;
    }
}

@keyframes finish-anim {
    from { right: -200px; }
    to { right: 100%; }
}

@keyframes mario-animation{
    0%{
        bottom: 0;
    }

    40%{
        bottom: 120px
    }

    50%{
        bottom: 120px;
    }

    60%{
        bottom: 120px
    }

    80%{
        bottom: 0px
    }

    100%{
        bottom: 0px
    }
}


@media (max-width: 75px){
    .mario{
        width: 75px;
        position: absolute;
        bottom: 0px;
    }

    .pipe{
        position: absolute;
        bottom: 0;
        width: 50px;
        animation: pipe-animations 2.5s infinite linear;
    }

    .finish {
        position: absolute;
        bottom: 0;
        width: 300px;
        right: -200px;
        display: none;
    }
    }

    </style>

<script>
     const mario = document.querySelector('.mario');
    const pipe = document.querySelector('.pipe');
    const finish = document.querySelector('.finish');
 
    const gameOver = document.querySelector('.game-over');
    const restartButton = document.querySelector('.restart');

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingBar = document.getElementById('loadingBar');
    const loadingText = document.getElementById('loadingText');

    // mostra overlay de carregamento e redireciona ao final
    function showLoading(targetUrl, duration = 1200) {
        loadingOverlay.style.display = 'flex';
        loadingBar.style.width = '0%';
        loadingText.textContent = 'Carregando proxima fase...';

         const start = performance.now();
        function tick(now) {
            const elapsed = now - start;
            const pct = Math.min(1, elapsed / duration);
            loadingBar.style.width = (pct * 100) + '%';
            if (pct < 1) {
                requestAnimationFrame(tick);
            } else {
                // pequena pausa para sensação de conclusão
                setTimeout(() => window.location.href = targetUrl, 180);
            }
        }
        requestAnimationFrame(tick);
    }
 
    // ao iniciar, aplica o personagem selecionado 
    const savedCharacter = localStorage.getItem('selectedCharacter');
    if (savedCharacter) {
        // garante caminho relativo (preserve nome)
        mario.src = savedCharacter;
    }
 
    let pipesPassed = 0;
    const pipesToFinish = 5;
    const nextPhaseUrl = 'deserto.html';
 
    const jump = () => {
        if (mario.classList.contains('jump')) return;
        mario.classList.add('jump');
        setTimeout(() => mario.classList.remove('jump'), 500);
    }
 
    pipe.addEventListener('animationiteration', () => {
        pipesPassed++;
        if (pipesPassed >= pipesToFinish) {
            pipe.style.display = 'none';
            finish.style.display = 'block';
            finish.style.animation = 'finish-anim 3000ms linear forwards';
        }
    });
 
    const loop = setInterval(() => {
        if (finish && finish.style.display === 'block') {
            const finishPosition = finish.offsetLeft;
            if (finishPosition <= 50) {
                finish.style.animation = 'none';
                finish.style.left = `${finishPosition}px`;
                clearInterval(loop);
                // chama tela de carregamento antes de ir para a próxima fase
                showLoading(nextPhaseUrl, 1000); // ajustar duração em ms se desejar
                return;
            }
        }
 
        if (pipe && pipe.style.display !== 'none') {
            const pipePosition = pipe.offsetLeft;
            const marioPosition = +window.getComputedStyle(mario).bottom.replace('px', '');
            if (pipePosition <= 50 && pipePosition > 0 && marioPosition < 65) {
                pipe.style.animation = 'none';
                pipe.style.left = `${pipePosition}px`;
                mario.style.animation = 'none';
                mario.style.bottom = `${marioPosition}px`;
                gameOver.style.visibility = 'visible';
                clearInterval(loop);
            }
        }
    }, 10);
 
    const restart = () => {
        gameOver.style.visibility = 'hidden';
        pipesPassed = 0;
        pipe.style.display = 'block';
        pipe.style.animation = 'pipe-animations 2.5s infinite linear';
        pipe.style.left = '';
        finish.style.display = 'none';
        finish.style.animation = 'none';
        finish.style.left = '';
        // restaura imagem do mario com a seleção salva (não limpa localStorage)
        const saved = localStorage.getItem('selectedCharacter');
        mario.src = saved;
        mario.style.width = '70px';
        mario.style.bottom = '0px';
        mario.style.marginLeft = '';
        mario.style.animation = '';
        // recarregar a página é opcional; aqui não recarrego para manter seleção
        // reiniciar loop simples: recarrega (ou você pode re-criar o setInterval). Para simplicidade:
        setTimeout(() => window.location.reload(), 200);
    }
 
    document.addEventListener('keydown', jump);
    document.addEventListener('touchstart', jump);
    restartButton.addEventListener('click', restart);

</script>
</body>
</html>